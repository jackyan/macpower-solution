# macpower 改进实施计划

## 概要
按照分析报告中的 P0-P3 优先级，对 macpower 项目的 6 个文件实施全面改进。

## 修改清单

### P0: 关键修复

#### 1. 修复 `restore_backup` 解析逻辑 (`bin/macpower:85-115`)
- 增加行格式校验：跳过空行、注释行、不匹配 `key value` 格式的行
- 增加 key 白名单校验（只允许已知的 pmset 参数名）
- 增加 value 校验（必须是数字）
- 在恢复前检查 block 变量是否已设置（避免在首个 section header 之前的行被误处理）
- 使用 `awk` 的 `NF` 过滤，确保行至少有两个字段

#### 2. 给所有变量引用加双引号 (`bin/macpower:58-64, 70-76`)
- `apply_policy` 函数中 `${scope_flag}` → `"${scope_flag}"`
- `restore_defaults` 函数中 `${scope_flag}` → `"${scope_flag}"`

### P1: 重要改进

#### 3. 放宽 `is_night_policy_active` 空白匹配 (`bin/macpower-auto:89-94`)
- 将 `^ standby\s+` 改为 `^\s+standby\s+`，容纳不同版本 macOS 的缩进差异（tab、多空格等）

#### 4. 日志目录从 `/tmp` 迁移到 `~/Library/Logs/macpower/` 
需修改文件：
- `launchd/com.user.macpower.night.plist`: StandardOutPath/StandardErrorPath
- `launchd/com.user.macpower.morning.plist`: StandardOutPath/StandardErrorPath
- `scripts/install.sh`: 安装时创建日志目录 `mkdir -p "$HOME/Library/Logs/macpower"`
- `README.md`: 更新日志路径引用

注意：plist 中不能使用 `~` 或 `$HOME`，需要使用绝对路径占位符并在 install.sh 中用 sed 替换为实际 HOME 路径。因此 plist 模板中将使用 `__HOME__` 占位符，install.sh 在复制时替换。

### P2: 次要改进

#### 5. 添加 `--version` 支持
- `bin/macpower`: 添加版本常量 `VERSION="1.0.0"`，在 `main` 的 case 中增加 `version|--version|-V` 分支
- `bin/macpower-auto`: 添加版本常量 `VERSION="3.3.0"`，在底部 case 中增加 `version|--version|-V` 分支
- `usage()` 中显示版本号

#### 6. `uninstall.sh` 清理残留文件 (`scripts/uninstall.sh`)
- 清理 `~/.macpower.night.enabled` (mark file)
- 清理 `~/.macpower.pmset.bak` (backup file) — 提示用户确认
- 清理 `~/Library/Logs/macpower/` 目录 — 提示用户确认

#### 7. install.sh 修复冗余 sudo 逻辑 (`scripts/install.sh:28-29`)
- 删除 `mkdir -p "$BIN_DIR"` 非 sudo 调用
- 保留 `sudo mkdir -p "$BIN_DIR"` 一次调用即可
- 使用 `launchctl bootout`/`bootstrap` 替代 `load`/`unload`（兼容写法：先尝试新 API，失败则 fallback 到旧 API）

### P3: 可选改进

#### 8. sudoers 保持不变（用户选择）

#### 9. 日志轮转
- 在 `macpower-auto` 的 `log()` 函数中加入简单日志轮转：当日志文件超过 1MB 时自动截断保留最近内容

### README 更新
- 更新日志路径（从 `/tmp` 改为 `~/Library/Logs/macpower/`）
- 更新 launchctl 命令示例（使用新 API + fallback）
- 添加 `--version` 用法

## 文件修改矩阵

| 文件 | 修改项编号 |
|---|---|
| `bin/macpower` | #1, #2, #5 |
| `bin/macpower-auto` | #3, #5, #9 |
| `scripts/install.sh` | #4, #7 |
| `scripts/uninstall.sh` | #6 |
| `launchd/com.user.macpower.night.plist` | #4 |
| `launchd/com.user.macpower.morning.plist` | #4 |
| `sudoers/macpower` | 不修改 |
| `README.md` | #4, #5, launchctl 更新 |

## 实施顺序
1. `bin/macpower` — P0 修复 + P2 版本号
2. `bin/macpower-auto` — P1 正则修复 + P2 版本号 + P3 日志轮转
3. `launchd/*.plist` — P1 日志路径
4. `scripts/install.sh` — P1 日志目录 + P2 launchctl 改进
5. `scripts/uninstall.sh` — P2 清理残留
6. `README.md` — 同步更新所有变更
