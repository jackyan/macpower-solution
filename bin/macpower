#!/usr/bin/env bash
set -euo pipefail

# macpower ‚Äî Low-power always-online mode controller (AC-only by default)
#
# Usage:
#   macpower on [--all|-a]
#   macpower off [--all|-a]
#   macpower status
#   macpower save
#   macpower restore
#
# Notes:
# - Default scope is AC only (-c). Use --all / -a to apply to all.
# - Uses sudo to run /usr/bin/pmset. For automation, configure sudoers NOPASSWD for /usr/bin/pmset.
# - Backup file: ~/.macpower.pmset.bak (saved from `pmset -g custom`)

BACKUP_FILE="${HOME}/.macpower.pmset.bak"

usage() {
  cat <<'USAGE'
Usage:
  macpower on [--all|-a]
  macpower off [--all|-a]
  macpower status
  macpower save
  macpower restore

Examples:
  macpower save
  macpower on
  macpower status
  macpower off
  macpower restore

Notes:
- Default scope is AC only (-c). Use --all / -a to apply to all.
- For non-interactive runs (launchd), configure sudoers to allow NOPASSWD: /usr/bin/pmset
USAGE
}

print_status() {
  echo "üîé Power source: $(/usr/bin/pmset -g batt 2>/dev/null | head -n 1)"
  echo ""
  echo "üìå Currently in use:"
  /usr/bin/pmset -g 2>/dev/null | sed -n '/Currently in use:/,$p' | head -n 60
  echo ""
  echo "‚öôÔ∏è Custom settings (AC/Battery/UPS):"
  /usr/bin/pmset -g custom 2>/dev/null
}

apply_policy() {
  local scope_flag="$1" # -c or -a

  # "Extreme low-power but always-online" targets:
  # - prevent system sleep / standby / autopoweroff
  # - keep screen off quickly and let disks sleep sooner
  sudo /usr/bin/pmset ${scope_flag} sleep 0
  sudo /usr/bin/pmset ${scope_flag} standby 0
  sudo /usr/bin/pmset ${scope_flag} autopoweroff 0
  sudo /usr/bin/pmset ${scope_flag} powernap 0
  sudo /usr/bin/pmset ${scope_flag} displaysleep 1
  sudo /usr/bin/pmset ${scope_flag} disksleep 5
  sudo /usr/bin/pmset ${scope_flag} tcpkeepalive 1
}

restore_defaults() {
  local scope_flag="$1" # -c or -a
  # Reasonable macOS-like defaults (feel free to edit to your preferences)
  sudo /usr/bin/pmset ${scope_flag} sleep 10
  sudo /usr/bin/pmset ${scope_flag} standby 1
  sudo /usr/bin/pmset ${scope_flag} autopoweroff 1
  sudo /usr/bin/pmset ${scope_flag} powernap 1
  sudo /usr/bin/pmset ${scope_flag} displaysleep 10
  sudo /usr/bin/pmset ${scope_flag} disksleep 10
  sudo /usr/bin/pmset ${scope_flag} tcpkeepalive 1
}

save_backup() {
  echo "üíæ Saving pmset custom settings to: ${BACKUP_FILE}"
  /usr/bin/pmset -g custom > "${BACKUP_FILE}"
  echo "‚úÖ Saved."
}

restore_backup() {
  if [[ ! -f "${BACKUP_FILE}" ]]; then
    echo "‚ùå Backup not found: ${BACKUP_FILE}"
    echo "Run: macpower save"
    exit 1
  fi

  echo "‚ôªÔ∏è Restoring pmset settings from: ${BACKUP_FILE}"

  local block=""
  while IFS= read -r line; do
    if echo "$line" | grep -q "Battery Power"; then block="batt"; continue; fi
    if echo "$line" | grep -q "AC Power"; then block="ac"; continue; fi
    if echo "$line" | grep -q "UPS Power"; then block="ups"; continue; fi

    local key value
    key="$(echo "$line" | awk '{print $1}')"
    value="$(echo "$line" | awk '{print $2}')"

    [[ -z "${key}" || -z "${value}" ]] && continue

    case "$block" in
      batt) sudo /usr/bin/pmset -b "${key}" "${value}" ;;
      ac)   sudo /usr/bin/pmset -c "${key}" "${value}" ;;
      ups)  sudo /usr/bin/pmset -u "${key}" "${value}" ;;
      *)    ;;
    esac
  done < "${BACKUP_FILE}"

  echo "‚úÖ Restored."
}

main() {
  if [[ $# -lt 1 ]]; then
    usage
    exit 1
  fi

  local action="$1"
  shift || true

  local scope="ac"    # ac|all
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --all|-a) scope="all" ;;
      -h|--help) usage; exit 0 ;;
      *) echo "Unknown option: $1"; usage; exit 2 ;;
    esac
    shift
  done

  local scope_flag="-c"
  [[ "$scope" == "all" ]] && scope_flag="-a"

  case "$action" in
    status)  print_status ;;
    save)    save_backup ;;
    restore) restore_backup ;;
    on)
      echo "üîß Enabling low-power always-online mode (scope: ${scope})..."
      apply_policy "${scope_flag}"
      echo "‚úÖ Enabled."
      echo ""
      print_status
      ;;
    off)
      echo "üîÑ Restoring defaults (scope: ${scope})..."
      restore_defaults "${scope_flag}"
      echo "‚úÖ Restored."
      echo ""
      print_status
      ;;
    *)
      echo "Unknown action: ${action}"
      usage
      exit 1
      ;;
  esac
}

main "$@"
