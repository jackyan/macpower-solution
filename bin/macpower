#!/usr/bin/env bash
set -euo pipefail

# macpower ‚Äî Low-power always-online mode controller (AC-only by default)
#
# Usage:
#   macpower on [--all|-a]
#   macpower off [--all|-a]
#   macpower status
#   macpower save
#   macpower restore
#
# Notes:
# - Default scope is AC only (-c). Use --all / -a to apply to all.
# - Uses sudo to run /usr/bin/pmset. For automation, configure sudoers NOPASSWD for /usr/bin/pmset.
# - Backup file: ~/.macpower.pmset.bak (saved from `pmset -g custom`)

BACKUP_FILE="${HOME}/.macpower.pmset.bak"

usage() {
  cat <<'USAGE'
Usage:
  macpower on [--all|-a]
  macpower off [--all|-a]
  macpower status
  macpower save
  macpower restore

Examples:
  macpower save
  macpower on
  macpower status
  macpower off
  macpower restore

Notes:
- Default scope is AC only (-c). Use --all / -a to apply to all.
- For non-interactive runs (launchd), configure sudoers to allow NOPASSWD: /usr/bin/pmset
USAGE
}

detect_night_policy() {
  # Check if current config matches night policy targets
  local out
  out="$(/usr/bin/pmset -g 2>/dev/null | sed -n '/Currently in use:/,$p')"

  # All these conditions must be true for night policy to be active
  echo "$out" | grep -qE "standby\s+0(\s|$)" && \
  echo "$out" | grep -qE "sleep\s+0(\s|$)" && \
  echo "$out" | grep -qE "powernap\s+0(\s|$)" && \
  echo "$out" | grep -qE "displaysleep\s+1(\s|$)" && \
  echo "$out" | grep -qE "disksleep\s+5(\s|$)" && \
  echo "$out" | grep -qE "tcpkeepalive\s+1(\s|$)"
}

print_mode_summary() {
  local power_source
  power_source="$(/usr/bin/pmset -g batt 2>/dev/null | head -n 1)"

  local is_night="0"
  detect_night_policy >/dev/null 2>&1 && is_night="1"

  echo "‚îå‚îÄ üìã ÁîµÊ∫êÊ®°ÂºèËØ¥Êòé ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê"
  echo "‚îÇ"

  if [[ "$is_night" == "1" ]]; then
    echo "‚îÇ  ÂΩìÂâçÊ®°ÂºèÔºöüåô ÊûÅËá¥ÁúÅÁîµÈïøÊúü‰ªªÂä°Ê®°ÂºèÔºàNight Policy ActiveÔºâ"
    echo "‚îÇ"
    echo "‚îÇ  ÂÖ≥ÈîÆÁâπÊÄßÔºö"
    echo "‚îÇ    ‚Ä¢ Á≥ªÁªüÊ∞∏‰∏ç‰ºëÁú†Ôºàsleep=0ÔºâÔºöÁΩëÁªúËøûÊé•ÂßãÁªà‰øùÊ¥ª"
    echo "‚îÇ    ‚Ä¢ Âø´ÈÄüÂ±èÂπïÁÜÑÁÅ≠Ôºà1ÂàÜÈíüÔºâÔºöÊúÄÂ∞èÂåñÂäüËÄó"
    echo "‚îÇ    ‚Ä¢ Á£ÅÁõòÂø´ÈÄü‰ºëÁú†Ôºà5ÂàÜÈíüÔºâÔºöËäÇÁúÅÁ£ÅÁõòÁîµËÉΩ"
    echo "‚îÇ    ‚Ä¢ TCP‰øùÊ¥ªÂ∑≤ÂêØÁî®Ôºàtcpkeepalive=1Ôºâ"
    echo "‚îÇ"
    echo "‚îÇ  üìå ÈïøÊúü‰ªªÂä°ÊîØÊåÅÔºö‚úÖ YES"
    echo "‚îÇ     ‚Ä¢ 24Â∞èÊó∂‰∏çÈó¥Êñ≠ËøêË°åÔºö‚úì"
    echo "‚îÇ     ‚Ä¢ Wi-Fi ‰øùÊåÅËøûÊé•Ôºö‚úì"
    echo "‚îÇ     ‚Ä¢ ÁΩëÁªúÈÄö‰ø°Á®≥ÂÆöÔºö‚úì"
    echo "‚îÇ     ‚Ä¢ Á¶ªÂºÄÂâçÊó†ÈúÄÂπ≤È¢ÑÔºö‚úì"
  else
    echo "‚îÇ  ÂΩìÂâçÊ®°ÂºèÔºöüí§ Ê†áÂáÜ/Áù°Áú†Ê®°ÂºèÔºàDefault/Standard ModeÔºâ"
    echo "‚îÇ"
    echo "‚îÇ  Ë°å‰∏∫ÁâπÊÄßÔºö"
    echo "‚îÇ    ‚Ä¢ Á≥ªÁªü‰ºöÂú® 10 ÂàÜÈíüÂ∑¶Âè≥ËøõÂÖ•Áù°Áú†"
    echo "‚îÇ    ‚Ä¢ ÂæÖÊú∫Ê®°ÂºèÂêØÁî®Ôºàstandby=1Ôºâ"
    echo "‚îÇ    ‚Ä¢ Power Nap ÂêØÁî®Ôºàpowernap=1Ôºâ"
    echo "‚îÇ    ‚Ä¢ Â±èÂπï 10 ÂàÜÈíüÁÜÑÁÅ≠ÔºåÁ£ÅÁõò 10 ÂàÜÈíü‰ºëÁú†"
    echo "‚îÇ"
    echo "‚îÇ  üìå ÈïøÊúü‰ªªÂä°ÊîØÊåÅÔºö‚ùå NO"
    echo "‚îÇ     ‚Ä¢ Á≥ªÁªü‰ºöËá™Âä®ËøõÂÖ•Áù°Áú†Ôºö‚úó"
    echo "‚îÇ     ‚Ä¢ Wi-Fi ÂèØËÉΩÊñ≠ÂºÄËøûÊé•Ôºö‚úó"
    echo "‚îÇ     ‚Ä¢ ‰∏çÈÄÇÂêàÁ¶ªÂºÄÁîµËÑëË∑ëÂêéÂè∞‰ªªÂä°Ôºö‚úó"
    echo "‚îÇ     ‚Ä¢ Ëã•Ë¶ÅË∑ë‰ªªÂä°ÔºåÈúÄÂÖàËøêË°åÔºömacpower on"
  fi

  echo "‚îÇ"
  echo "‚îÇ  ÁîµÊ∫êÊù•Ê∫êÔºö$power_source"
  echo "‚îÇ"
  echo "‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò"
  echo ""
}

print_status() {
  print_mode_summary
  echo "üìå Currently in use:"
  /usr/bin/pmset -g 2>/dev/null | sed -n '/Currently in use:/,$p' | head -n 60
  echo ""
  echo "‚öôÔ∏è Custom settings (AC/Battery/UPS):"
  /usr/bin/pmset -g custom 2>/dev/null
}

apply_policy() {
  local scope_flag="$1" # -c or -a

  # "Extreme low-power but always-online" targets:
  # - prevent system sleep / standby / autopoweroff
  # - keep screen off quickly and let disks sleep sooner
  sudo /usr/bin/pmset ${scope_flag} sleep 0
  sudo /usr/bin/pmset ${scope_flag} standby 0
  sudo /usr/bin/pmset ${scope_flag} autopoweroff 0
  sudo /usr/bin/pmset ${scope_flag} powernap 0
  sudo /usr/bin/pmset ${scope_flag} displaysleep 1
  sudo /usr/bin/pmset ${scope_flag} disksleep 5
  sudo /usr/bin/pmset ${scope_flag} tcpkeepalive 1
}

restore_defaults() {
  local scope_flag="$1" # -c or -a
  # Reasonable macOS-like defaults (feel free to edit to your preferences)
  sudo /usr/bin/pmset ${scope_flag} sleep 10
  sudo /usr/bin/pmset ${scope_flag} standby 1
  sudo /usr/bin/pmset ${scope_flag} autopoweroff 1
  sudo /usr/bin/pmset ${scope_flag} powernap 1
  sudo /usr/bin/pmset ${scope_flag} displaysleep 10
  sudo /usr/bin/pmset ${scope_flag} disksleep 10
  sudo /usr/bin/pmset ${scope_flag} tcpkeepalive 1
}

save_backup() {
  echo "üíæ Saving pmset custom settings to: ${BACKUP_FILE}"
  /usr/bin/pmset -g custom > "${BACKUP_FILE}"
  echo "‚úÖ Saved."
}

restore_backup() {
  if [[ ! -f "${BACKUP_FILE}" ]]; then
    echo "‚ùå Backup not found: ${BACKUP_FILE}"
    echo "Run: macpower save"
    exit 1
  fi

  echo "‚ôªÔ∏è Restoring pmset settings from: ${BACKUP_FILE}"

  local block=""
  while IFS= read -r line; do
    if echo "$line" | grep -q "Battery Power"; then block="batt"; continue; fi
    if echo "$line" | grep -q "AC Power"; then block="ac"; continue; fi
    if echo "$line" | grep -q "UPS Power"; then block="ups"; continue; fi

    local key value
    key="$(echo "$line" | awk '{print $1}')"
    value="$(echo "$line" | awk '{print $2}')"

    [[ -z "${key}" || -z "${value}" ]] && continue

    case "$block" in
      batt) sudo /usr/bin/pmset -b "${key}" "${value}" ;;
      ac)   sudo /usr/bin/pmset -c "${key}" "${value}" ;;
      ups)  sudo /usr/bin/pmset -u "${key}" "${value}" ;;
      *)    ;;
    esac
  done < "${BACKUP_FILE}"

  echo "‚úÖ Restored."
}

main() {
  if [[ $# -lt 1 ]]; then
    usage
    exit 1
  fi

  local action="$1"
  shift || true

  local scope="ac"    # ac|all
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --all|-a) scope="all" ;;
      -h|--help) usage; exit 0 ;;
      *) echo "Unknown option: $1"; usage; exit 2 ;;
    esac
    shift
  done

  local scope_flag="-c"
  [[ "$scope" == "all" ]] && scope_flag="-a"

  case "$action" in
    status)  print_status ;;
    save)    save_backup ;;
    restore) restore_backup ;;
    on)
      echo "üîß Enabling low-power always-online mode (scope: ${scope})..."
      apply_policy "${scope_flag}"
      echo "‚úÖ Enabled."
      echo ""
      print_status
      ;;
    off)
      echo "üîÑ Restoring defaults (scope: ${scope})..."
      restore_defaults "${scope_flag}"
      echo "‚úÖ Restored."
      echo ""
      print_status
      ;;
    *)
      echo "Unknown action: ${action}"
      usage
      exit 1
      ;;
  esac
}

main "$@"
