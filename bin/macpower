#!/usr/bin/env bash
set -euo pipefail

# macpower ‚Äî Low-power always-online mode controller (AC-only by default)
#
# Usage:
#   macpower on [--all|-a] [--force]
#   macpower off [--all|-a]
#   macpower status
#   macpower save
#   macpower restore
#
# Notes:
# - Default scope is AC only (-c). Use --all / -a to apply to all.
# - macpower on checks for network connectivity before applying. Use --force to skip.
# - Uses sudo to run /usr/bin/pmset. For automation, configure sudoers NOPASSWD for /usr/bin/pmset.
# - Backup file: ~/.macpower.pmset.bak (saved from `pmset -g custom`)

BACKUP_FILE="${HOME}/.macpower.pmset.bak"

usage() {
  cat <<'USAGE'
Usage:
  macpower on [--all|-a] [--force]
  macpower off [--all|-a]
  macpower status
  macpower save
  macpower restore

Examples:
  macpower save
  macpower on
  macpower status
  macpower off
  macpower restore

Notes:
- Default scope is AC only (-c). Use --all / -a to apply to all.
- macpower on checks for network connectivity (Wi-Fi or Ethernet) before
  applying. Use --force to skip this check.
- macpower off applies a conservative preset (NOT factory defaults).
  For true factory settings, use: macpower restore (requires prior: macpower save)
- For non-interactive runs (launchd), configure sudoers to allow NOPASSWD: /usr/bin/pmset
USAGE
}

is_network_connected() {
  # Returns 0 (true) if a default route exists, meaning at least one network
  # interface (Wi-Fi or Ethernet) is connected and has a gateway.
  # Uses route table lookup ‚Äî instant, no packets sent, firewall-safe.
  /sbin/route get default 2>/dev/null | grep -q "interface:"
}

detect_night_policy() {
  # Check if current config matches night policy targets.
  # NOTE: all patterns are anchored with ^\s* to prevent substring matches,
  # e.g. "sleep" must not match "displaysleep" or "disksleep".
  local out
  out="$(/usr/bin/pmset -g 2>/dev/null | sed -n '/Currently in use:/,$p')"

  # Check the parameters that reliably appear in pmset -g on both Intel and M-series.
  # autopoweroff is intentionally excluded: M-series Macs do not expose it in
  # "Currently in use" output, so checking it would always return false on Apple Silicon.
  echo "$out" | grep -qE "^\s*sleep\s+0(\s|$)" && \
  echo "$out" | grep -qE "^\s*standby\s+0(\s|$)" && \
  echo "$out" | grep -qE "^\s*powernap\s+0(\s|$)" && \
  echo "$out" | grep -qE "^\s*displaysleep\s+1(\s|$)" && \
  echo "$out" | grep -qE "^\s*disksleep\s+5(\s|$)" && \
  echo "$out" | grep -qE "^\s*tcpkeepalive\s+1(\s|$)"
}

print_mode_summary() {
  local power_source
  power_source="$(/usr/bin/pmset -g batt 2>/dev/null | head -n 1)"

  local is_night="0"
  # [M-2] detect_night_policy only uses exit code, no output to redirect
  detect_night_policy && is_night="1" || true

  echo "‚îå‚îÄ üìã ÁîµÊ∫êÊ®°ÂºèËØ¥Êòé ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê"
  echo "‚îÇ"

  if [[ "$is_night" == "1" ]]; then
    echo "‚îÇ  ÂΩìÂâçÊ®°ÂºèÔºöüåô ÊûÅËá¥ÁúÅÁîµÈïøÊúü‰ªªÂä°Ê®°ÂºèÔºà‰ΩéÂäüËÄó‰øùÊ¥ªÂ∑≤ÂºÄÂêØÔºâ"
    echo "‚îÇ"
    echo "‚îÇ  ÂÖ≥ÈîÆÁâπÊÄßÔºö"
    echo "‚îÇ    ‚Ä¢ Á≥ªÁªüÊ∞∏‰∏ç‰ºëÁú†Ôºàsleep=0ÔºâÔºöÁΩëÁªúËøûÊé•ÂßãÁªà‰øùÊ¥ª"
    echo "‚îÇ    ‚Ä¢ Âø´ÈÄüÂ±èÂπïÁÜÑÁÅ≠Ôºà1ÂàÜÈíüÔºâÔºöÊúÄÂ∞èÂåñÂäüËÄó"
    echo "‚îÇ    ‚Ä¢ Á£ÅÁõòÂø´ÈÄü‰ºëÁú†Ôºà5ÂàÜÈíüÔºâÔºöËäÇÁúÅÁ£ÅÁõòÁîµËÉΩ"
    echo "‚îÇ    ‚Ä¢ TCP‰øùÊ¥ªÂ∑≤ÂêØÁî®Ôºàtcpkeepalive=1Ôºâ"
    echo "‚îÇ"
    echo "‚îÇ  üìå ÈïøÊúü‰ªªÂä°ÊîØÊåÅÔºö‚úÖ YES"
    echo "‚îÇ     ‚Ä¢ 24Â∞èÊó∂‰∏çÈó¥Êñ≠ËøêË°åÔºö‚úì"
    echo "‚îÇ     ‚Ä¢ Wi-Fi ‰øùÊåÅËøûÊé•Ôºö‚úì"
    echo "‚îÇ     ‚Ä¢ ÁΩëÁªúÈÄö‰ø°Á®≥ÂÆöÔºö‚úì"
    echo "‚îÇ     ‚Ä¢ Á¶ªÂºÄÂâçÊó†ÈúÄÂπ≤È¢ÑÔºö‚úì"
  else
    local cur_sleep cur_displaysleep
    cur_sleep="$(/usr/bin/pmset -g 2>/dev/null | sed -n '/Currently in use:/,$p' | awk '/^[[:space:]]*sleep[[:space:]]+/{print $2; exit}')"
    cur_displaysleep="$(/usr/bin/pmset -g 2>/dev/null | sed -n '/Currently in use:/,$p' | awk '/^[[:space:]]*displaysleep[[:space:]]+/{print $2; exit}')"

    echo "‚îÇ  ÂΩìÂâçÊ®°ÂºèÔºöüí§ Èùû‰ΩéÂäüËÄó‰øùÊ¥ªÊ®°ÂºèÔºàÁ≥ªÁªüÂèØËÉΩËøõÂÖ•‰ºëÁú†Ôºâ"
    echo "‚îÇ"
    echo "‚îÇ  Ë°å‰∏∫ÁâπÊÄßÔºàÂΩìÂâçÂÆûÈôÖÂÄºÔºâÔºö"
    echo "‚îÇ    ‚Ä¢ Á≥ªÁªü‰ºëÁú†Êó∂Èó¥Ôºö${cur_sleep:-?} ÂàÜÈíüÂêéÔºàsleep=${cur_sleep:-?}Ôºâ"
    echo "‚îÇ    ‚Ä¢ Â±èÂπïÁÜÑÁÅ≠Êó∂Èó¥Ôºö${cur_displaysleep:-?} ÂàÜÈíüÂêéÔºàdisplaysleep=${cur_displaysleep:-?}Ôºâ"
    echo "‚îÇ    ‚Ä¢ Ê≥®ÊÑèÔºöÁ≥ªÁªü‰ºëÁú†Âêé Wi-Fi ÂèØËÉΩÊñ≠ÂºÄ"
    echo "‚îÇ"
    echo "‚îÇ  üìå ÈïøÊúü‰ªªÂä°ÊîØÊåÅÔºö‚ùå NO"
    echo "‚îÇ     ‚Ä¢ Á≥ªÁªü‰ºöËá™Âä®ËøõÂÖ•Áù°Áú†Ôºàsleep ‚â† 0ÔºâÔºö‚úó"
    echo "‚îÇ     ‚Ä¢ Wi-Fi ÂèØËÉΩÊñ≠ÂºÄËøûÊé•Ôºö‚úó"
    echo "‚îÇ     ‚Ä¢ ‰∏çÈÄÇÂêàÁ¶ªÂºÄÁîµËÑëË∑ëÂêéÂè∞‰ªªÂä°Ôºö‚úó"
    echo "‚îÇ     ‚Ä¢ Ëã•Ë¶ÅË∑ë‰ªªÂä°ÔºåÈúÄÂÖàËøêË°åÔºömacpower on"
  fi

  echo "‚îÇ"
  echo "‚îÇ  ÁîµÊ∫êÊù•Ê∫êÔºö$power_source"
  echo "‚îÇ"
  echo "‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò"
  echo ""
}

print_status() {
  print_mode_summary
  echo "üìå Currently in use:"
  /usr/bin/pmset -g 2>/dev/null | sed -n '/Currently in use:/,$p' | head -n 60
  echo ""
  echo "‚öôÔ∏è Custom settings (AC/Battery/UPS):"
  /usr/bin/pmset -g custom 2>/dev/null
}

apply_policy() {
  # [H-2] scope_flag is quoted to prevent word splitting
  local scope_flag="$1" # -c or -a
  local errors=0

  # "Extreme low-power but always-online" targets:
  # - prevent system sleep / standby / autopoweroff
  # - keep screen off quickly and let disks sleep sooner
  # [C-1] Each pmset call tolerates individual failure to avoid partial-apply abort
  sudo /usr/bin/pmset "${scope_flag}" sleep 0          || { echo "WARN: failed to set sleep"; ((errors++)) || true; }
  sudo /usr/bin/pmset "${scope_flag}" standby 0        || { echo "WARN: failed to set standby"; ((errors++)) || true; }
  sudo /usr/bin/pmset "${scope_flag}" autopoweroff 0   || { echo "WARN: failed to set autopoweroff"; ((errors++)) || true; }
  sudo /usr/bin/pmset "${scope_flag}" powernap 0       || { echo "WARN: failed to set powernap"; ((errors++)) || true; }
  sudo /usr/bin/pmset "${scope_flag}" displaysleep 1   || { echo "WARN: failed to set displaysleep"; ((errors++)) || true; }
  sudo /usr/bin/pmset "${scope_flag}" disksleep 5      || { echo "WARN: failed to set disksleep"; ((errors++)) || true; }
  sudo /usr/bin/pmset "${scope_flag}" tcpkeepalive 1   || { echo "WARN: failed to set tcpkeepalive"; ((errors++)) || true; }

  if [[ "$errors" -gt 0 ]]; then
    echo "‚ö†Ô∏è  ${errors} parameter(s) failed to apply. Check sudo/pmset permissions."
    return 1
  fi
  return 0
}

restore_defaults() {
  # [L-3] These are NOT factory defaults ‚Äî they are a conservative preset.
  # For true factory settings, use: macpower restore (requires prior: macpower save)
  local scope_flag="$1" # -c or -a
  local errors=0

  sudo /usr/bin/pmset "${scope_flag}" sleep 10         || { echo "WARN: failed to set sleep"; ((errors++)) || true; }
  sudo /usr/bin/pmset "${scope_flag}" standby 1        || { echo "WARN: failed to set standby"; ((errors++)) || true; }
  sudo /usr/bin/pmset "${scope_flag}" autopoweroff 1   || { echo "WARN: failed to set autopoweroff"; ((errors++)) || true; }
  sudo /usr/bin/pmset "${scope_flag}" powernap 1       || { echo "WARN: failed to set powernap"; ((errors++)) || true; }
  sudo /usr/bin/pmset "${scope_flag}" displaysleep 10  || { echo "WARN: failed to set displaysleep"; ((errors++)) || true; }
  sudo /usr/bin/pmset "${scope_flag}" disksleep 10     || { echo "WARN: failed to set disksleep"; ((errors++)) || true; }
  sudo /usr/bin/pmset "${scope_flag}" tcpkeepalive 1   || { echo "WARN: failed to set tcpkeepalive"; ((errors++)) || true; }

  if [[ "$errors" -gt 0 ]]; then
    echo "‚ö†Ô∏è  ${errors} parameter(s) failed to apply. Check sudo/pmset permissions."
    return 1
  fi
  return 0
}

save_backup() {
  echo "üíæ Saving pmset custom settings to: ${BACKUP_FILE}"
  /usr/bin/pmset -g custom > "${BACKUP_FILE}"
  # [L-1] Restrict backup file permissions
  chmod 600 "${BACKUP_FILE}"
  echo "‚úÖ Saved."
}

restore_backup() {
  if [[ ! -f "${BACKUP_FILE}" ]]; then
    echo "‚ùå Backup not found: ${BACKUP_FILE}"
    echo "Run: macpower save"
    exit 1
  fi

  echo "‚ôªÔ∏è Restoring pmset settings from: ${BACKUP_FILE}"

  local block="" errors=0
  while IFS= read -r line; do
    # [C-2] Anchor block detection at line start to prevent substring matches
    if echo "$line" | grep -qE "^Battery Power:"; then block="batt"; continue; fi
    if echo "$line" | grep -qE "^AC Power:"; then block="ac"; continue; fi
    if echo "$line" | grep -qE "^UPS Power:"; then block="ups"; continue; fi

    local key value
    key="$(echo "$line" | awk '{print $1}')"
    value="$(echo "$line" | awk '{print $2}')"

    [[ -z "${key}" || -z "${value}" ]] && continue

    # [C-1] Tolerate individual pmset failures to avoid partial restore abort
    case "$block" in
      batt) sudo /usr/bin/pmset -b "${key}" "${value}" || { echo "WARN: failed to restore batt ${key}=${value}"; ((errors++)) || true; } ;;
      ac)   sudo /usr/bin/pmset -c "${key}" "${value}" || { echo "WARN: failed to restore ac ${key}=${value}"; ((errors++)) || true; } ;;
      ups)  sudo /usr/bin/pmset -u "${key}" "${value}" || { echo "WARN: failed to restore ups ${key}=${value}"; ((errors++)) || true; } ;;
      *)    ;;
    esac
  done < "${BACKUP_FILE}"

  if [[ "$errors" -gt 0 ]]; then
    echo "‚ö†Ô∏è  Restored with ${errors} error(s). Some settings may not have been applied."
    return 1
  fi
  echo "‚úÖ Restored."
}

main() {
  if [[ $# -lt 1 ]]; then
    usage
    exit 1
  fi

  local action="$1"
  shift || true

  local scope="ac"    # ac|all
  local force="0"
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --all|-a)    scope="all" ;;
      --force|-f)  force="1" ;;
      -h|--help)   usage; exit 0 ;;
      *) echo "Unknown option: $1"; usage; exit 2 ;;
    esac
    shift
  done

  local scope_flag="-c"
  [[ "$scope" == "all" ]] && scope_flag="-a"

  case "$action" in
    status)  print_status ;;
    save)    save_backup ;;
    restore) restore_backup ;;
    on)
      if [[ "$force" != "1" ]] && ! is_network_connected; then
        echo "‚è≠Ô∏è  SKIP: No network connection detected (Wi-Fi and Ethernet both offline)."
        echo "   Connect to a network first, then run: macpower on"
        echo "   To override this check: macpower on --force"
        exit 0
      fi
      echo "üîß Enabling low-power always-online mode (scope: ${scope})..."
      apply_policy "${scope_flag}"
      echo "‚úÖ Enabled."
      echo ""
      print_status
      ;;
    off)
      echo "üîÑ Applying conservative preset (scope: ${scope})..."
      echo "   Note: This is NOT factory defaults. For true restore, use: macpower restore"
      restore_defaults "${scope_flag}"
      echo "‚úÖ Done."
      echo ""
      print_status
      ;;
    *)
      echo "Unknown action: ${action}"
      usage
      exit 1
      ;;
  esac
}

main "$@"
