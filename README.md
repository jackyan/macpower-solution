# macpower å®Œæ•´è§£å†³æ–¹æ¡ˆï¼ˆM ç³»åˆ— / å¤œé—´ä¸æ–­çº¿ / çœç”µï¼‰

è¿™ä¸ªåŒ…æŠŠ"**æè‡´çœç”µä½†ä¸æ–­çº¿**"æ–¹æ¡ˆæ•´ç†æˆä¸€ä¸ªå¯å®‰è£…çš„å®Œæ•´ä½“ï¼ŒåŒ…æ‹¬ï¼š
- ç³»ç»Ÿçº§å‘½ä»¤ï¼š`macpower`
- æ™ºèƒ½è‡ªåŠ¨åŒ–åŒ…è£…ï¼š`macpower-auto`ï¼ˆv3.3ï¼‰
- launchd å®šæ—¶ä»»åŠ¡ï¼š23:00 è‡ªåŠ¨å¼€å¯ã€08:00 è‡ªåŠ¨æ¢å¤ï¼ˆå¸¦ç¯å¢ƒåˆ¤æ–­ä¸æŠ¤æ ï¼‰
- å®‰è£…/å¸è½½è„šæœ¬
- sudoers æ¨¡æ¿ï¼ˆè®©è‡ªåŠ¨åŒ–å¯åœ¨æ— äº¤äº’ç¯å¢ƒä¿®æ”¹ pmsetï¼‰

> ç›®æ ‡ï¼šå¤œé—´éœ€è¦è·‘ä»»åŠ¡æ—¶ï¼Œ**ä¸è¿›å…¥ç³»ç»Ÿ sleep å¯¼è‡´ç½‘ç»œæ–­å¼€**ï¼›åŒæ—¶å°½é‡çœç”µï¼ˆå±å¹• 1 åˆ†é’Ÿç­ã€ç£ç›˜ 5 åˆ†é’Ÿä¼‘çœ ï¼‰ã€‚

---

## ä¸€ã€ä½ å°†å¾—åˆ°ä»€ä¹ˆ

### 1) `macpower`ï¼ˆç³»ç»Ÿçº§ CLIï¼‰

| å‘½ä»¤ | è¯´æ˜ |
|------|------|
| `macpower on` | å¼€å¯å¤œè·‘ç­–ç•¥ï¼ˆé»˜è®¤åªå½±å“ **æ’ç”µ AC**ï¼‰ï¼Œç½‘ç»œæœªè¿æ¥æ—¶è‡ªåŠ¨ SKIP |
| `macpower on --force` | å¼€å¯å¤œè·‘ç­–ç•¥ï¼Œè·³è¿‡ç½‘ç»œæ£€æµ‹ |
| `macpower off` | æ¢å¤"ç±»é»˜è®¤"ç”µæºç­–ç•¥ï¼ˆACï¼‰ |
| `macpower save` | å¤‡ä»½å½“å‰ `pmset -g custom` åˆ° `~/.macpower.pmset.bak` |
| `macpower restore` | ä»å¤‡ä»½å›æ»šï¼ˆæ¨èä¼˜å…ˆç”¨è¿™ä¸ªï¼‰ |
| `macpower status` | æŸ¥çœ‹å½“å‰çŠ¶æ€ï¼ˆå«ä¸­æ–‡æ¨¡å¼è¯´æ˜ï¼‰ |

**å¤œè·‘ç­–ç•¥ï¼ˆACï¼‰å‚æ•°ï¼š**
- `sleep 0`ã€`standby 0`ã€`autopoweroff 0`ã€`powernap 0`
- `displaysleep 1`ã€`disksleep 5`
- `tcpkeepalive 1`

> **å…³äº disksleep 5**ï¼šç£ç›˜ä¼‘çœ åªå½±å“å­˜å‚¨ç¡¬ä»¶çš„çœç”µçŠ¶æ€ï¼Œ**ä¸ä¼šä¸­æ–­æ­£åœ¨è¿è¡Œçš„ç¨‹åºæˆ–ç½‘ç»œä»»åŠ¡**ã€‚è¿è¡Œä¸­çš„è¿›ç¨‹å’Œç½‘ç»œè¿æ¥éƒ½åœ¨å†…å­˜é‡Œï¼Œä¸ç£ç›˜æ— å…³ã€‚å¦‚éœ€è®¿é—®ç£ç›˜ï¼ˆå¦‚å†™æ—¥å¿—ï¼‰ï¼ŒmacOS ä¼šåœ¨æ¯«ç§’çº§å†…è‡ªåŠ¨å”¤é†’ç£ç›˜ï¼Œè¿›ç¨‹ä¸ä¼šå¤±è´¥ã€‚

**`macpower status` è¾“å‡ºè¯´æ˜ï¼š**

`status` å‘½ä»¤ä¼šåœ¨åŸå§‹ pmset å‚æ•°ä¸Šæ–¹ï¼Œè‡ªåŠ¨æ˜¾ç¤ºä¸€æ®µ**ä¸­æ–‡æ¨¡å¼è¯´æ˜**ï¼Œç›´æ¥å‘Šè¯‰ä½ ï¼š
- å½“å‰å¤„äºå“ªä¸ªæ¨¡å¼ï¼ˆå¤œè·‘ç­–ç•¥ / éå¤œè·‘ç­–ç•¥ï¼‰
- ç³»ç»Ÿä¼‘çœ ä¸å±å¹•ç†„ç­çš„å®é™…æ—¶é—´
- **èƒ½å¦ç¦»å¼€ç”µè„‘è·‘é•¿æœŸä»»åŠ¡ï¼ˆYES / NOï¼‰**

ç¤ºä¾‹ï¼ˆå¤œè·‘ç­–ç•¥å·²å¼€å¯ï¼‰ï¼š
```
â”Œâ”€ ğŸ“‹ ç”µæºæ¨¡å¼è¯´æ˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚
â”‚  å½“å‰æ¨¡å¼ï¼šğŸŒ™ æè‡´çœç”µé•¿æœŸä»»åŠ¡æ¨¡å¼ï¼ˆNight Policy Activeï¼‰
â”‚
â”‚  å…³é”®ç‰¹æ€§ï¼š
â”‚    â€¢ ç³»ç»Ÿæ°¸ä¸ä¼‘çœ ï¼ˆsleep=0ï¼‰ï¼šç½‘ç»œè¿æ¥å§‹ç»ˆä¿æ´»
â”‚    â€¢ å¿«é€Ÿå±å¹•ç†„ç­ï¼ˆ1åˆ†é’Ÿï¼‰ï¼šæœ€å°åŒ–åŠŸè€—
â”‚    â€¢ ç£ç›˜å¿«é€Ÿä¼‘çœ ï¼ˆ5åˆ†é’Ÿï¼‰ï¼šèŠ‚çœç£ç›˜ç”µèƒ½
â”‚    â€¢ TCPä¿æ´»å·²å¯ç”¨ï¼ˆtcpkeepalive=1ï¼‰
â”‚
â”‚  ğŸ“Œ é•¿æœŸä»»åŠ¡æ”¯æŒï¼šâœ… YES
â”‚     â€¢ 24å°æ—¶ä¸é—´æ–­è¿è¡Œï¼šâœ“
â”‚     â€¢ Wi-Fi ä¿æŒè¿æ¥ï¼šâœ“
â”‚     â€¢ ç½‘ç»œé€šä¿¡ç¨³å®šï¼šâœ“
â”‚     â€¢ ç¦»å¼€å‰æ— éœ€å¹²é¢„ï¼šâœ“
â”‚
â”‚  ç”µæºæ¥æºï¼šNow drawing from 'AC Power'
â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2) `macpower-auto`ï¼ˆæ™ºèƒ½åˆ¤æ–­ï¼‰

- **23:00 è§¦å‘**æ—¶ï¼Œä¼šå…ˆæ£€æŸ¥ï¼š
  - æ˜¯å¦æ’ç”µï¼ˆACï¼‰ã€‚ä¸æ’ç”µç›´æ¥ SKIP
  - Wiâ€‘Fi æ˜¯å¦è¿æ¥åˆ°æŸä¸ª SSIDã€‚æœªè¿æ¥åˆ™ SKIP
  - ç›–å­æ˜¯å¦åˆä¸Šï¼šé»˜è®¤ SKIP
  - æ˜¯å¦å·²æ˜¯å¤œè·‘ç­–ç•¥ï¼šè‹¥å·²å¼€å¯ï¼ˆåŒ…æ‹¬æ‰‹åŠ¨ `macpower on`ï¼‰ï¼Œ**è¯†åˆ«åè·³è¿‡ï¼Œåªè¡¥å†™æ ‡è®°æ–‡ä»¶ç¡®ä¿æ—©ä¸Šä¼šæ¢å¤**
- **morning æ¢å¤**æ—¶ï¼šåªæœ‰åœ¨ night çœŸå¼€å¯/æ ‡è®°è¿‡æ‰ä¼šæ¢å¤ï¼Œé¿å…è¯¯æ”¹ã€‚

### 3) LaunchAgents

- `com.user.macpower.night`ï¼šæ¯å¤© 23:00 è¿è¡Œ `macpower-auto night`
- `com.user.macpower.morning`ï¼šæ¯å¤© 08:00 è¿è¡Œ `macpower-auto morning`
- æ—¥å¿—ï¼š
  - `/tmp/macpower_night.log` `/tmp/macpower_night.err`
  - `/tmp/macpower_morning.log` `/tmp/macpower_morning.err`

---

## äºŒã€å®‰è£…

### æ–¹å¼ Aï¼šä¸€é”®å®‰è£…ï¼ˆæ¨èï¼‰

åœ¨é¡¹ç›®ç›®å½•é‡Œè¿è¡Œï¼š

```bash
bash scripts/install.sh
```

å®‰è£…è„šæœ¬ä¼šï¼š
- æŠŠ `macpower` / `macpower-auto` å¤åˆ¶åˆ°ï¼š
  - ä¼˜å…ˆ `/opt/homebrew/bin`ï¼ˆå¤šæ•° M ç³»åˆ—æœºå™¨ï¼‰
  - å¦åˆ™ `/usr/local/bin`
- æŠŠä¸¤ä¸ª plist å¤åˆ¶åˆ° `~/Library/LaunchAgents` å¹¶è‡ªåŠ¨ load
- å¯é€‰ï¼šå¸®ä½ å®‰è£… sudoersï¼ˆæ¨èå®‰è£…ï¼‰

> å®‰è£…å®Œæˆåå»ºè®®åšä¸€æ¬¡å¤‡ä»½ï¼š
```bash
macpower save
```

### æ–¹å¼ Bï¼šæ‰‹åŠ¨å®‰è£…
1. å¤åˆ¶è„šæœ¬åˆ° PATH ç›®å½•ï¼Œå¹¶ `chmod +x`
2. å¤åˆ¶ plist åˆ° `~/Library/LaunchAgents`
3. `launchctl load ...`

---

## ä¸‰ã€sudoersï¼ˆè‡ªåŠ¨åŒ–å¿…éœ€ï¼‰

`pmset` ä¿®æ”¹ç³»ç»Ÿç”µæºç­–ç•¥éœ€è¦ root æƒé™ã€‚
launchd åˆ°ç‚¹æ‰§è¡Œæ²¡æœ‰äº¤äº’ç»ˆç«¯ï¼Œä¸èƒ½è¾“å…¥ sudo å¯†ç ï¼Œæ‰€ä»¥éœ€è¦æ”¾è¡Œï¼š

- å…è®¸ä½ å¯¹ `/usr/bin/pmset` ä½¿ç”¨å…å¯† sudo

æ¨¡æ¿åœ¨ï¼š`sudoers/macpower`

å®‰è£…æ–¹å¼ï¼ˆæ¨èç”¨ visudoï¼‰ï¼š

```bash
sudo visudo -f /etc/sudoers.d/macpower
```

æŠŠæ¨¡æ¿å†…å®¹ç²˜è´´è¿›å»ï¼Œå¹¶æŠŠ `YOUR_USERNAME` æ”¹æˆ `whoami` çš„ç»“æœã€‚

éªŒè¯ï¼š

```bash
sudo /usr/sbin/visudo -cf /etc/sudoers.d/macpower
```

---

## å››ã€æ—¥å¸¸ä½¿ç”¨

### æ‰‹åŠ¨å¼€å¯/æ¢å¤
```bash
macpower on          # å¼€å¯å¤œè·‘ç­–ç•¥ï¼ˆéœ€æœ‰ç½‘ç»œè¿æ¥ï¼‰
macpower on --force  # å¼€å¯å¤œè·‘ç­–ç•¥ï¼ˆè·³è¿‡ç½‘ç»œæ£€æµ‹ï¼‰
macpower status      # æŸ¥çœ‹å½“å‰æ¨¡å¼å’Œé•¿æœŸä»»åŠ¡æ”¯æŒçŠ¶æ€
macpower restore     # æ¨èï¼šä»å¤‡ä»½å›æ»šåˆ°åŸå§‹è®¾ç½®
```

### æŸ¥çœ‹è‡ªåŠ¨åŒ–çŠ¶æ€
```bash
macpower-auto status
launchctl list | grep macpower
```

### æ‰‹åŠ¨è§¦å‘ä¸€æ¬¡å¤œé—´é€»è¾‘ï¼ˆä¸ç”¨ç­‰ 23:00ï¼‰
```bash
macpower-auto night
```

### æ‰‹åŠ¨è§¦å‘ä¸€æ¬¡æ—©ä¸Šæ¢å¤ï¼ˆä¸ç”¨ç­‰ 08:00ï¼‰
```bash
macpower-auto morning
```

---

## äº”ã€ç»´æŠ¤ä¸æ’éšœ

### 1) ä¸ºä»€ä¹ˆæ™šä¸Šç»å¸¸"ä»€ä¹ˆéƒ½æ²¡å‘ç”Ÿ"ï¼Ÿ

ä¸¤ç§å¯èƒ½ï¼š
- **ä¸æ’ç”µ**ï¼š`macpower-auto night` æ£€æµ‹åˆ°é AC â†’ SKIPï¼ˆä¿å®ˆé€»è¾‘ï¼Œé¢„æœŸè¡Œä¸ºï¼‰
- **Wi-Fi æœªè¿æ¥**ï¼šæœªè¿æ¥ç½‘ç»œ â†’ SKIP

æŸ¥çœ‹æ—¥å¿—ç¡®è®¤åŸå› ï¼š
```bash
tail -n 50 /tmp/macpower_night.log
```

### 2) æˆ‘æ‰‹åŠ¨å¼€äº† `macpower on`ï¼Œæ™šä¸Š 23:00 ä¼šé‡å¤æ‰§è¡Œå—ï¼Ÿ

ä¸ä¼šé‡å¤ applyã€‚23:00 çš„ä»»åŠ¡ä¼šæ£€æµ‹åˆ°"night policy already active"ï¼Œç›´æ¥è·³è¿‡å¹¶è¡¥å†™æ ‡è®°æ–‡ä»¶ï¼Œç¡®ä¿ 08:00 è‡ªåŠ¨ restoreã€‚å®Œæ•´æµç¨‹ï¼š

```
æ‰‹åŠ¨ macpower on â†’ å¤œè·‘ç­–ç•¥å·²æ¿€æ´» + mark file å†™å…¥
23:00 â†’ æ£€æµ‹åˆ°å·²æ¿€æ´» â†’ é™é»˜è·³è¿‡ï¼ˆno changes appliedï¼‰
08:00 â†’ å‘ç° mark file â†’ macpower restore â†’ æ¸…é™¤ mark file
```

### 3) `macpower on` æç¤º SKIP: No network connection æ€ä¹ˆåŠï¼Ÿ

è¯´æ˜å½“å‰ Wi-Fi å’Œä»¥å¤ªç½‘éƒ½æœªè¿æ¥ã€‚è¿æ¥ç½‘ç»œåé‡è¯•ï¼Œæˆ–å¼ºåˆ¶æ‰§è¡Œï¼š
```bash
macpower on --force
```

### 4) ç£ç›˜ä¼‘çœ ï¼ˆdisksleep 5ï¼‰ä¼šå½±å“è¿è¡Œä¸­çš„ç¨‹åºå—ï¼Ÿ

**ä¸å½±å“ã€‚** ç£ç›˜ä¼‘çœ åªæ˜¯è®©å­˜å‚¨ç¡¬ä»¶è¿›å…¥çœç”µçŠ¶æ€ï¼ŒCPUã€å†…å­˜ã€ç½‘ç»œå…¨éƒ¨ä¿æŒæ´»è·ƒã€‚è¿è¡Œä¸­çš„ç¨‹åºå’Œç½‘ç»œè¿æ¥ä¸ä¾èµ–ç£ç›˜ã€‚å¦‚æœç¨‹åºéœ€è¦å†™ç£ç›˜ï¼ˆå†™æ—¥å¿—ç­‰ï¼‰ï¼ŒmacOS ä¼šåœ¨æ¯«ç§’çº§å†…è‡ªåŠ¨å”¤é†’ç£ç›˜ï¼Œè¿›ç¨‹é€æ˜ç­‰å¾…ï¼Œä¸ä¼šæŠ¥é”™æˆ–ä¸­æ–­ã€‚

### 5) æŸ¥çœ‹æ—¥å¿—
```bash
tail -n 200 /tmp/macpower_night.log /tmp/macpower_night.err
tail -n 200 /tmp/macpower_morning.log /tmp/macpower_morning.err
```

### 6) æƒ³æ”¹æ—¶é—´ï¼ˆæ¯”å¦‚ 22:30 / 7:30ï¼‰
ç¼–è¾‘ `~/Library/LaunchAgents/*.plist` çš„ `StartCalendarInterval`ï¼Œç„¶åï¼š
```bash
launchctl unload ~/Library/LaunchAgents/com.user.macpower.night.plist
launchctl unload ~/Library/LaunchAgents/com.user.macpower.morning.plist
launchctl load ~/Library/LaunchAgents/com.user.macpower.night.plist
launchctl load ~/Library/LaunchAgents/com.user.macpower.morning.plist
```

### 7) å¦‚æœä½ ç¡®å®æƒ³å¶å°”åˆç›–è·‘ï¼ˆå¯é€‰ï¼‰
è„šæœ¬ä¿ç•™äº†"æ˜¾å¼åˆç›–è·‘"å¼€å…³ï¼š
```bash
macpower-auto night --clamshell
```
å®ƒä¼šè¦æ±‚æ£€æµ‹åˆ°å¤–æ¥æ˜¾ç¤ºå™¨ / dummy HDMIï¼Œå¦åˆ™æ‹’ç»ï¼ˆé¿å…åˆç›–å®é™…ç¡çœ æ–­ç½‘ï¼‰ã€‚

---

## å…­ã€å¸è½½

```bash
bash scripts/uninstall.sh
```

å¯é€‰ï¼šåˆ é™¤ sudoers
```bash
sudo rm -f /etc/sudoers.d/macpower
```

---

## ä¸ƒã€å®‰å…¨è¯´æ˜

- æœ¬æ–¹æ¡ˆé€šè¿‡ sudoers æ”¾è¡Œäº† `pmset` å…å¯†æ‰§è¡Œï¼ˆåªæ”¾è¡Œä¸€ä¸ªç³»ç»Ÿå‘½ä»¤ï¼‰ã€‚
- è¿™æ˜¯ä¸ºäº†è®© launchd è‡ªåŠ¨åŒ–åœ¨æ— äº¤äº’ç¯å¢ƒä¸‹ç”Ÿæ•ˆã€‚
- å¦‚æœä½ ä¸å¸Œæœ›å…å¯†ï¼Œè¯·ä¸è¦è£… sudoersï¼›ä½†è‡ªåŠ¨åŒ–å°†æ— æ³•ä¿®æ”¹ç”µæºç­–ç•¥ï¼ˆåªä¼šåœ¨æ—¥å¿—é‡Œå¤±è´¥ï¼‰ã€‚
